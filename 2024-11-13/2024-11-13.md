# 연결지향형 TCP 프로토콜

<aside>
✏️

TCP 프로토콜 구조와 TCP의 플래그

TCP가 하는 일

: 전송 제어 프로토콜(TCP)은 인터켓에 연결된 컴퓨터에서 실행되는 프로그램 간에 통신을 안정적으로, 순서대로, 에러없이 교환할 수 있게 한다.

: TCP의 안정성을 필요로 하지 않는 애플리케이션의 경우 일반적으로 TCP 대신 비접속형 사용자 데이터그램 프로토콜을 사용한다.

TCP 프로토콜의 구조

- Source Port : 2byte
- Destination Port : 2byte
- Sequence Number : 4byte
- Acknowledgement Number : 4byte
- Offset : 헤더의 길이
- Reserved : 예약된 필드로 사용하지 않음
- Checksum
- Window : 사용공간이 얼마나 남아있는지 알려주는 필드 즉, 남아있는 TCP 버퍼 공간을 알려줌
- Usgent Pointer
- TCP Option : 일반적으로 잘 안붙고 붙더라도 4byte씩 붙으며 총 10개까지 붙을 수 있음

TCP 플래그

: 플래그는 TCP가 계속해서 통신을 하면서 지속해서 상대방과의 연결 상태를 물어보는데, 어떤 플래그를 보내는것인지에 따라 데이터를 관리할 수 있음

각 플래그의 기능

- U flagurgent Flag로, 우선순위가 높은 데이터가 포함되어있을 때 지정
    - U가 1로 세팅되어있을 때 좀 빨리 처리해주는 녀석
    - Urgent Pointer가 어디서부터 긴급 데이터인지 알려주는 위치값
- A flagACK Flag로, TCP에서 중요하고 사용이 많이 되는 녀석
    - 승인 비트로 데이터를 보내도 되는지 확인 응답을 받는 필드
- P flagPush Flag로, TCP 버퍼가 일정한 크기만큼 쌓여야 패킷을 추가적으로 전송하는데, 버퍼 상관없이 계속해서 데이터를 밀어넣겠다는 표현
    - 많이 사용하지 않음
- R flagReset Flag로, 상대방과 연결이 되어있는 상태에서 추가적으로 데이터를 주고받을 때 문제가 발생해서 둘 사이의 연결관계를 reset 하는 Flag
- S flagSYN Flag로, 동기화 플래그
    - 상대방과 연결을 시작할 때 무조건 사용하는 플래그로써, 해당 비트가 처음 보내지고 난 이후부터 둘 사이의 연결이 동기화되기 시작함
- F flagFin Flag로 종료 플래그
    - 연결을 끊을 때 사용하는 플래그

TCP를 이용한 통신 과정

연결 수립 과정

: TCP를 이용한 데이터 통신을 할 때 프로세스와 프로세스를 연결하기 위해 가장 먼저 수행되는 과정

: 통신을 하려고 할 때 가장 먼저 수행되는 과정이며, 해당 과정이 수행되고 난 이후에 데이터가 전달이 되기 시작함

1. 클라이언트가 서버에게 연결해도 되는지에 대한 요청 패킷을 보내고
2. 서버가 클라이언트의 요청을 받아들이는 패킷을 보내고
3. 클라이언트는 이를 최종적으로 수락하는 패킷을 보낸다.

⇒ 위 3개의 과정을 3Way Handshake라고 부른다.

데이터 송수신 과정

: 연결이 수립된 상태에서 데이터를 송수신할 때에는 연결이 수립되었을 때의 SEQ 번호와 ACK 번호를 그대로 이어간다.

: 마지막에 클라이언트가 서버로 패킷을 보내고 끝나는데, 연결된 상태에서 클라이언트가 다시 데이터를 보냄

: TCP를 이용한 데이터 통신을 할 때 단순히 TCP 패킷만을 캡슐화해서 통신하는 것이 아닌 페이로드를 포함한 주고받을 때의 일정한 규칙

1. 보낸 쪽에서 또 보낼 때는 SEQ 번호와 ACK 번호가 그대로다.
2. 받는 쪽에서 SEQ 번호는 받는 ACK 번호가 된다.
3. 받는 쪽에서 ACK 번호는 받는 SEQ 번호 + 데이터의 크기

TCP 연결 상태의 변화

- LISTEN
    - 4계층은 포트번호를 사용하는데, 포트번호를 열어놓고 있는 상태를 말한다.
    - 서버가 클라이언트의 요청을 계속 듣고 있는 상태.
    - 서버가 포트를 열어서 LISTEN상태로 만들 때 passive open
- ESTABLISHED
    - 연결이 서로 수립이 된 상태를 말한다.
    - 3 way handshake 상태가 끝나면 ESTABLISHED 상태가 되어 통신이 가능해짐.
- CLOSED
    - 클라이언트도 본인의 포트를 사용하고 원래는 포트가 닫혀있는 상태클라이언트가 포트를 사용할 때 active open
- SYN_SENT
    - 클라이언트가 포트를 열면서 SYN 패킷을 flag 세팅하여 서버로 전달
- SYN_RCVD
    - SYN를 받은 서버는 SYN_RCVD 상태가 되고, SYN, ACK 패킷을 보내게 됨
</aside>